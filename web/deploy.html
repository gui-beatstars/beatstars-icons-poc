<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Deploy â€” BeatStars Icons</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --background: #09090b;
      --foreground: #fafafa;
      --card: #18181b;
      --card-foreground: #fafafa;
      --primary: #fafafa;
      --primary-foreground: #18181b;
      --secondary: #27272a;
      --secondary-foreground: #fafafa;
      --muted: #27272a;
      --muted-foreground: #a1a1aa;
      --accent: #C32D2D;
      --accent-foreground: #ffffff;
      --accent-subtle: rgba(195, 45, 45, 0.08);
      --border: rgba(255, 255, 255, 0.08);
      --input: rgba(255, 255, 255, 0.12);
      --ring: #a1a1aa;
      --radius: 0.625rem;
      --font-sans: 'Inter', -apple-system, system-ui, sans-serif;
      --font-mono: 'JetBrains Mono', ui-monospace, monospace;
      --success: #22c55e;
      --warning: #eab308;
    }

    html { font-size: 16px; }

    body {
      font-family: var(--font-sans);
      background: var(--background);
      color: var(--foreground);
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
    }

    /* ---- HEADER ---- */
    .header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: rgba(9, 9, 11, 0.80);
      backdrop-filter: blur(12px) saturate(180%);
      border-bottom: 1px solid var(--border);
    }

    .header-inner {
      max-width: 1200px;
      margin: 0 auto;
      padding: 14px 24px;
      display: flex;
      align-items: center;
      gap: 24px;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      text-decoration: none;
      flex-shrink: 0;
    }

    .logo-mark {
      width: 28px;
      height: 28px;
      background: var(--accent);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .logo-mark svg { width: 15px; height: 15px; }

    .logo-text {
      font-weight: 600;
      font-size: 1rem;
      color: var(--foreground);
      letter-spacing: -0.01em;
    }

    .logo-text span { color: var(--muted-foreground); font-weight: 400; }

    .nav { display: flex; gap: 4px; flex: 1; }

    .nav a {
      display: inline-flex;
      align-items: center;
      padding: 6px 14px;
      border-radius: calc(var(--radius) - 4px);
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--muted-foreground);
      text-decoration: none;
      transition: color 0.15s, background 0.15s;
    }

    .nav a:hover { color: var(--foreground); background: var(--secondary); }
    .nav a.active { color: var(--foreground); background: var(--secondary); }

    /* ---- MAIN ---- */
    .main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 40px 24px 80px;
      display: flex;
      flex-direction: column;
      gap: 32px;
    }

    .page-title {
      font-size: 1.75rem;
      font-weight: 700;
      letter-spacing: -0.03em;
    }

    .page-desc {
      color: var(--muted-foreground);
      font-size: 0.9375rem;
      margin-top: 6px;
      line-height: 1.5;
    }

    /* ---- CARDS ---- */
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 24px;
    }

    .card-title {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .card-title svg { color: var(--muted-foreground); flex-shrink: 0; }

    /* ---- PIPELINE DIAGRAM ---- */
    .pipeline {
      display: flex;
      align-items: center;
      gap: 0;
      flex-wrap: wrap;
      padding: 8px 0;
    }

    .pipeline-step {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 14px;
      background: var(--secondary);
      border: 1px solid var(--border);
      border-radius: calc(var(--radius) - 2px);
      font-size: 0.8125rem;
      font-weight: 500;
      color: var(--muted-foreground);
      white-space: nowrap;
    }

    .pipeline-step svg { width: 16px; height: 16px; flex-shrink: 0; }

    .pipeline-step.active {
      border-color: var(--accent);
      color: var(--accent);
      background: var(--accent-subtle);
    }

    .pipeline-step.done {
      border-color: var(--success);
      color: var(--success);
    }

    .pipeline-arrow {
      color: var(--muted-foreground);
      opacity: 0.4;
      font-size: 1rem;
      padding: 0 6px;
    }

    /* ---- TOKEN INPUT ---- */
    .token-row {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .token-input-wrap {
      position: relative;
      flex: 1;
      max-width: 480px;
    }

    .token-input {
      width: 100%;
      height: 40px;
      border-radius: calc(var(--radius) - 4px);
      border: 1px solid var(--input);
      background: var(--background);
      padding: 8px 40px 8px 14px;
      font-family: var(--font-mono);
      font-size: 0.8125rem;
      color: var(--foreground);
      outline: none;
      transition: border-color 0.15s, box-shadow 0.15s;
    }

    .token-input:focus {
      border-color: var(--ring);
      box-shadow: 0 0 0 2px var(--background), 0 0 0 4px var(--ring);
    }

    .token-input::placeholder { color: var(--muted-foreground); }

    .token-toggle {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: var(--muted-foreground);
      cursor: pointer;
      padding: 4px;
      display: flex;
      align-items: center;
    }

    .token-toggle:hover { color: var(--foreground); }

    .token-hint {
      font-size: 0.75rem;
      color: var(--muted-foreground);
      margin-top: 8px;
      line-height: 1.5;
    }

    .token-hint code {
      font-family: var(--font-mono);
      background: var(--secondary);
      padding: 1px 5px;
      border-radius: 3px;
      font-size: 0.7rem;
    }

    .token-saved {
      font-size: 0.75rem;
      color: var(--success);
      display: none;
      align-items: center;
      gap: 4px;
    }

    .token-saved.show { display: inline-flex; }

    /* ---- TRIGGER ---- */
    .trigger-row {
      display: flex;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
    }

    .btn-trigger {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      height: 48px;
      padding: 0 28px;
      border-radius: var(--radius);
      background: var(--accent);
      color: var(--accent-foreground);
      border: 1px solid var(--accent);
      font-family: var(--font-sans);
      font-size: 0.9375rem;
      font-weight: 600;
      cursor: pointer;
      transition: filter 0.15s, opacity 0.15s;
      white-space: nowrap;
    }

    .btn-trigger:hover { filter: brightness(1.12); }
    .btn-trigger:disabled { opacity: 0.5; cursor: not-allowed; filter: none; }

    .btn-trigger svg {
      width: 20px;
      height: 20px;
    }

    .btn-trigger.loading svg {
      animation: spin 1s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .trigger-status {
      font-size: 0.875rem;
      color: var(--muted-foreground);
    }

    /* ---- STATUS DISPLAY ---- */
    .status-card {
      display: none;
    }

    .status-card.show { display: block; }

    .status-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 12px;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .status-badge.queued { background: rgba(234, 179, 8, 0.15); color: var(--warning); }
    .status-badge.in_progress { background: rgba(59, 130, 246, 0.15); color: #3b82f6; }
    .status-badge.completed-success { background: rgba(34, 197, 94, 0.15); color: var(--success); }
    .status-badge.completed-failure { background: rgba(239, 68, 68, 0.15); color: #ef4444; }

    .status-badge::before {
      content: '';
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: currentColor;
    }

    .status-badge.in_progress::before {
      animation: pulse-dot 1.5s ease-in-out infinite;
    }

    @keyframes pulse-dot {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    .status-meta {
      font-size: 0.8125rem;
      color: var(--muted-foreground);
    }

    .status-link {
      color: var(--accent);
      text-decoration: none;
      font-size: 0.8125rem;
    }

    .status-link:hover { text-decoration: underline; }

    /* Steps */
    .steps-list {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-top: 16px;
    }

    .step-row {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      border-radius: calc(var(--radius) - 4px);
      font-size: 0.8125rem;
      color: var(--muted-foreground);
    }

    .step-row.active { background: var(--secondary); color: var(--foreground); }
    .step-row.done { color: var(--success); }
    .step-row.failed { color: #ef4444; }

    .step-icon {
      width: 16px;
      height: 16px;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .step-icon.spinner svg { animation: spin 1s linear infinite; }

    .step-name { flex: 1; }

    .step-duration {
      font-family: var(--font-mono);
      font-size: 0.75rem;
      opacity: 0.6;
    }

    /* ---- RECENT RUNS ---- */
    .runs-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8125rem;
    }

    .runs-table th {
      text-align: left;
      font-weight: 500;
      color: var(--muted-foreground);
      padding: 8px 12px;
      border-bottom: 1px solid var(--border);
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .runs-table td {
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      color: var(--muted-foreground);
    }

    .runs-table tr:last-child td { border-bottom: none; }

    .runs-table a { color: var(--accent); text-decoration: none; }
    .runs-table a:hover { text-decoration: underline; }

    .mini-badge {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      font-weight: 500;
    }

    .mini-badge::before {
      content: '';
      width: 6px;
      height: 6px;
      border-radius: 50%;
    }

    .mini-badge.success::before { background: var(--success); }
    .mini-badge.failure::before { background: #ef4444; }
    .mini-badge.in_progress::before { background: #3b82f6; }
    .mini-badge.queued::before { background: var(--warning); }
    .mini-badge.cancelled::before { background: var(--muted-foreground); }

    .empty-runs {
      color: var(--muted-foreground);
      font-size: 0.8125rem;
      padding: 24px 0;
      text-align: center;
      opacity: 0.6;
    }

    /* ---- RESPONSIVE ---- */
    @media (max-width: 768px) {
      .main { padding: 24px 16px 60px; }
      .header-inner { padding: 12px 16px; gap: 12px; }
      .pipeline { gap: 4px; }
      .pipeline-arrow { display: none; }
      .pipeline-step { font-size: 0.7rem; padding: 6px 10px; }
      .token-input-wrap { max-width: 100%; }
      .trigger-row { flex-direction: column; align-items: flex-start; }
    }
  </style>
</head>
<body>

  <header class="header">
    <div class="header-inner">
      <a class="logo" href="index.html">
        <div class="logo-mark">
          <svg viewBox="0 0 16 16" fill="none" stroke="#000" stroke-width="2" stroke-linecap="round">
            <circle cx="8" cy="8" r="3" /><path d="M8 2v2M8 12v2M2 8h2M12 8h2" />
          </svg>
        </div>
        <div class="logo-text">BeatStars <span>Icons</span></div>
      </a>
      <nav class="nav">
        <a href="index.html">Icons</a>
        <a href="deploy.html" class="active">Deploy</a>
      </nav>
    </div>
  </header>

  <main class="main">
    <div>
      <h1 class="page-title">Deploy Dashboard</h1>
      <p class="page-desc">Sync icons from Figma, rebuild the library, and publish to the catalog.</p>
    </div>

    <!-- Pipeline -->
    <div class="card">
      <div class="card-title">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M4 12h16M4 12l4-4M4 12l4 4M20 12l-4-4M20 12l-4 4"/></svg>
        Pipeline
      </div>
      <div class="pipeline" id="pipeline">
        <div class="pipeline-step" data-step="fetch">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4M10 17l5-5-5-5M13.8 12H3"/></svg>
          Fetch from Figma
        </div>
        <span class="pipeline-arrow">&rarr;</span>
        <div class="pipeline-step" data-step="optimize">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="m21.64 3.64-1.28-1.28a1.21 1.21 0 0 0-1.72 0L2.36 18.64a1.21 1.21 0 0 0 0 1.72l1.28 1.28a1.2 1.2 0 0 0 1.72 0L21.64 5.36a1.2 1.2 0 0 0 0-1.72Z"/><path d="m14 7 3 3"/></svg>
          Optimize SVGs
        </div>
        <span class="pipeline-arrow">&rarr;</span>
        <div class="pipeline-step" data-step="generate">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="m18 16 4-4-4-4"/><path d="m6 8-4 4 4 4"/><path d="m14.5 4-5 16"/></svg>
          Generate React
        </div>
        <span class="pipeline-arrow">&rarr;</span>
        <div class="pipeline-step" data-step="build">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg>
          Build Library
        </div>
        <span class="pipeline-arrow">&rarr;</span>
        <div class="pipeline-step" data-step="deploy">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 0 0-2.91-.09z"/><path d="m12 15-3-3a22 22 0 0 1 2-3.95A12.88 12.88 0 0 1 22 2c0 2.72-.78 7.5-6 11a22.35 22.35 0 0 1-4 2z"/><path d="M9 12H4s.55-3.03 2-4c1.62-1.08 5 0 5 0"/><path d="M12 15v5s3.03-.55 4-2c1.08-1.62 0-5 0-5"/></svg>
          Deploy Catalog
        </div>
      </div>
    </div>

    <!-- Token -->
    <div class="card">
      <div class="card-title">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
        GitHub Token
      </div>
      <div class="token-row">
        <div class="token-input-wrap">
          <input type="password" class="token-input" id="token-input" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx" spellcheck="false" autocomplete="off" />
          <button class="token-toggle" id="token-toggle" title="Show/hide token">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>
          </button>
        </div>
        <span class="token-saved" id="token-saved">Saved</span>
      </div>
      <div class="token-hint">
        Requires a GitHub Personal Access Token with <code>repo</code> and <code>actions</code> scopes.
        <a href="https://github.com/settings/tokens/new?scopes=repo,actions&description=BeatStars+Icons+Deploy" target="_blank" rel="noopener" style="color: var(--accent);">Create one &rarr;</a>
      </div>
    </div>

    <!-- Trigger -->
    <div class="card">
      <div class="card-title">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 0 0-2.91-.09z"/><path d="m12 15-3-3a22 22 0 0 1 2-3.95A12.88 12.88 0 0 1 22 2c0 2.72-.78 7.5-6 11a22.35 22.35 0 0 1-4 2z"/></svg>
        Trigger
      </div>
      <div class="trigger-row">
        <button class="btn-trigger" id="btn-trigger" disabled>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/></svg>
          Sync Icons from Figma
        </button>
        <span class="trigger-status" id="trigger-status"></span>
      </div>
    </div>

    <!-- Live Status -->
    <div class="card status-card" id="status-card">
      <div class="card-title">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
        Current Run
      </div>
      <div class="status-header">
        <span class="status-badge" id="status-badge">queued</span>
        <span class="status-meta" id="status-meta"></span>
      </div>
      <a class="status-link" id="status-link" href="#" target="_blank" rel="noopener">View on GitHub &rarr;</a>
      <div class="steps-list" id="steps-list"></div>
    </div>

    <!-- Recent Runs -->
    <div class="card">
      <div class="card-title">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/></svg>
        Recent Runs
      </div>
      <div id="recent-runs">
        <div class="empty-runs">No runs yet. Trigger your first sync above.</div>
      </div>
    </div>
  </main>

  <script>
    const OWNER = 'gui-beatstars';
    const REPO = 'beatstars-icons-poc';
    const WORKFLOW_FILE = 'rebuild-icons.yml';

    // ---- DOM ----
    const tokenInput = document.getElementById('token-input');
    const tokenToggle = document.getElementById('token-toggle');
    const tokenSaved = document.getElementById('token-saved');
    const btnTrigger = document.getElementById('btn-trigger');
    const triggerStatus = document.getElementById('trigger-status');
    const statusCard = document.getElementById('status-card');
    const statusBadge = document.getElementById('status-badge');
    const statusMeta = document.getElementById('status-meta');
    const statusLink = document.getElementById('status-link');
    const stepsList = document.getElementById('steps-list');
    const recentRuns = document.getElementById('recent-runs');
    const pipeline = document.getElementById('pipeline');

    // ---- Token ----
    const savedToken = localStorage.getItem('gh_deploy_token');
    if (savedToken) {
      tokenInput.value = savedToken;
      btnTrigger.disabled = false;
      tokenSaved.classList.add('show');
    }

    tokenInput.addEventListener('input', () => {
      const val = tokenInput.value.trim();
      if (val) {
        localStorage.setItem('gh_deploy_token', val);
        btnTrigger.disabled = false;
        tokenSaved.classList.add('show');
      } else {
        localStorage.removeItem('gh_deploy_token');
        btnTrigger.disabled = true;
        tokenSaved.classList.remove('show');
      }
    });

    tokenToggle.addEventListener('click', () => {
      tokenInput.type = tokenInput.type === 'password' ? 'text' : 'password';
    });

    function getToken() {
      return tokenInput.value.trim();
    }

    function ghFetch(path, opts = {}) {
      return fetch(`https://api.github.com${path}`, {
        ...opts,
        headers: {
          'Authorization': `Bearer ${getToken()}`,
          'Accept': 'application/vnd.github+json',
          'X-GitHub-Api-Version': '2022-11-28',
          ...opts.headers,
        },
      });
    }

    // ---- Trigger ----
    let polling = false;
    let pollTimer = null;

    btnTrigger.addEventListener('click', async () => {
      if (!getToken()) return;
      btnTrigger.disabled = true;
      btnTrigger.classList.add('loading');
      triggerStatus.textContent = 'Dispatching workflow...';

      try {
        const res = await ghFetch(`/repos/${OWNER}/${REPO}/actions/workflows/${WORKFLOW_FILE}/dispatches`, {
          method: 'POST',
          body: JSON.stringify({ ref: 'main' }),
        });

        if (res.status === 204) {
          triggerStatus.textContent = 'Workflow dispatched. Waiting for run to appear...';
          statusCard.classList.add('show');
          resetPipeline();
          // Wait a moment for GitHub to register the run, then start polling
          setTimeout(() => startPolling(), 3000);
        } else {
          const err = await res.json();
          triggerStatus.textContent = `Error: ${err.message || res.statusText}`;
          btnTrigger.disabled = false;
          btnTrigger.classList.remove('loading');
        }
      } catch (e) {
        triggerStatus.textContent = `Network error: ${e.message}`;
        btnTrigger.disabled = false;
        btnTrigger.classList.remove('loading');
      }
    });

    // ---- Polling ----
    async function startPolling() {
      if (polling) return;
      polling = true;
      poll();
    }

    async function poll() {
      if (!polling) return;

      try {
        // Get latest dispatch run
        const runsRes = await ghFetch(`/repos/${OWNER}/${REPO}/actions/workflows/${WORKFLOW_FILE}/runs?per_page=1`);
        const runsData = await runsRes.json();
        const run = runsData.workflow_runs?.[0];

        if (!run) {
          pollTimer = setTimeout(poll, 4000);
          return;
        }

        updateStatus(run);

        // Get job steps
        const jobsRes = await ghFetch(`/repos/${OWNER}/${REPO}/actions/runs/${run.id}/jobs`);
        const jobsData = await jobsRes.json();
        if (jobsData.jobs?.[0]) {
          updateSteps(jobsData.jobs[0].steps || []);
        }

        if (run.status === 'completed') {
          polling = false;
          btnTrigger.disabled = false;
          btnTrigger.classList.remove('loading');
          triggerStatus.textContent = run.conclusion === 'success'
            ? 'Icons synced successfully!'
            : `Run failed: ${run.conclusion}`;
          loadRecentRuns();
        } else {
          pollTimer = setTimeout(poll, 4000);
        }
      } catch (e) {
        pollTimer = setTimeout(poll, 4000);
      }
    }

    function updateStatus(run) {
      const status = run.status;
      const conclusion = run.conclusion;

      statusBadge.textContent = conclusion || status;
      statusBadge.className = 'status-badge';
      if (status === 'completed') {
        statusBadge.classList.add(`completed-${conclusion}`);
      } else {
        statusBadge.classList.add(status);
      }

      const started = new Date(run.run_started_at || run.created_at);
      const elapsed = run.status === 'completed' && run.updated_at
        ? Math.round((new Date(run.updated_at) - started) / 1000)
        : Math.round((Date.now() - started) / 1000);
      statusMeta.textContent = `${elapsed}s elapsed`;
      statusLink.href = run.html_url;
    }

    function updateSteps(steps) {
      // Map steps to pipeline stages
      const stageMap = {
        'Fetch, optimize, generate, and build': ['fetch', 'optimize', 'generate', 'build'],
        'Commit and push changes': ['deploy'],
      };

      stepsList.innerHTML = steps.map(step => {
        let icon, cls;
        if (step.status === 'completed') {
          if (step.conclusion === 'success') {
            icon = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="20 6 9 17 4 12"/></svg>';
            cls = 'done';
          } else if (step.conclusion === 'skipped') {
            icon = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M5 12h14"/></svg>';
            cls = '';
          } else {
            icon = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>';
            cls = 'failed';
          }
        } else if (step.status === 'in_progress') {
          icon = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>';
          cls = 'active';
        } else {
          icon = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="12" cy="12" r="10"/></svg>';
          cls = '';
        }

        const duration = step.started_at && step.completed_at
          ? Math.round((new Date(step.completed_at) - new Date(step.started_at)) / 1000) + 's'
          : '';

        // Update pipeline diagram
        if (stageMap[step.name]) {
          stageMap[step.name].forEach(stage => {
            const el = pipeline.querySelector(`[data-step="${stage}"]`);
            if (el) {
              el.classList.remove('active', 'done');
              if (step.status === 'in_progress') el.classList.add('active');
              else if (step.conclusion === 'success') el.classList.add('done');
            }
          });
        }

        return `<div class="step-row ${cls}">
          <span class="step-icon${step.status === 'in_progress' ? ' spinner' : ''}">${icon}</span>
          <span class="step-name">${step.name}</span>
          <span class="step-duration">${duration}</span>
        </div>`;
      }).join('');
    }

    function resetPipeline() {
      pipeline.querySelectorAll('.pipeline-step').forEach(el => {
        el.classList.remove('active', 'done');
      });
    }

    // ---- Recent Runs ----
    async function loadRecentRuns() {
      if (!getToken()) return;
      try {
        const res = await ghFetch(`/repos/${OWNER}/${REPO}/actions/workflows/${WORKFLOW_FILE}/runs?per_page=5`);
        const data = await res.json();
        const runs = data.workflow_runs || [];

        if (runs.length === 0) {
          recentRuns.innerHTML = '<div class="empty-runs">No runs yet.</div>';
          return;
        }

        recentRuns.innerHTML = `<table class="runs-table">
          <thead><tr><th>Status</th><th>Triggered</th><th>Duration</th><th>Link</th></tr></thead>
          <tbody>${runs.map(run => {
            const status = run.conclusion || run.status;
            const started = new Date(run.run_started_at || run.created_at);
            const duration = run.status === 'completed' && run.updated_at
              ? Math.round((new Date(run.updated_at) - started) / 1000) + 's'
              : '...';
            const timeAgo = formatTimeAgo(started);
            return `<tr>
              <td><span class="mini-badge ${status}">${status}</span></td>
              <td>${timeAgo} by ${run.actor?.login || '?'}</td>
              <td style="font-family:var(--font-mono);font-size:0.75rem">${duration}</td>
              <td><a href="${run.html_url}" target="_blank" rel="noopener">View</a></td>
            </tr>`;
          }).join('')}</tbody>
        </table>`;
      } catch {}
    }

    function formatTimeAgo(date) {
      const s = Math.round((Date.now() - date) / 1000);
      if (s < 60) return `${s}s ago`;
      const m = Math.round(s / 60);
      if (m < 60) return `${m}m ago`;
      const h = Math.round(m / 60);
      if (h < 24) return `${h}h ago`;
      return `${Math.round(h / 24)}d ago`;
    }

    // ---- Init: load recent runs if token exists ----
    if (getToken()) loadRecentRuns();
  </script>
</body>
</html>
